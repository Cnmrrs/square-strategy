<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Square Strategy: Economy Update</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e272e;
            --player: #3498db;
            --enemy: #c0392b;
            --barb: #d35400;
            --gold: #f1c40f;
            --text: #ecf0f1;
            --green: #2ecc71;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- √úST PANEL --- */
        #header {
            background: var(--panel);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-size: 13px;
            z-index: 100;
        }
        .header-left, .header-right { display: flex; gap: 5px; align-items: center; }
        
        .badge { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 11px;}
        .gold-txt { color: var(--gold); }

        .icon-btn {
            background: #444; border: none; color: white; border-radius: 5px;
            width: 32px; height: 32px; cursor: pointer; font-size: 16px; 
            display:flex; justify-content:center; align-items:center;
            transition: 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        .btn-help { background: #2980b9; }
        .btn-quest { background: #8e44ad; }
        .btn-skin { background: #16a085; }

        /* --- OYUN ALANI --- */
        #game-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            width: 95vw;
            max-width: 500px;
            aspect-ratio: 1/1;
            position: relative;
            z-index: 10;
        }

        .tile {
            background: #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.6);
            position: relative;
            transition: transform 0.1s, background 0.2s;
        }
        
        .tile.player { background: var(--player); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.enemy { background: var(--enemy); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.barbarian { background: var(--barb); border-bottom: 3px solid rgba(0,0,0,0.3); animation: shake 0.5s; }
        .tile.neutral { background: #555; opacity: 0.7; }

        .tile.revealed { border: 2px solid var(--barb); }

        .trap-indicator {
            position: absolute; bottom: 2px; right: 2px;
            width: 6px; height: 6px; background: cyan;
            border-radius: 50%; box-shadow: 0 0 4px white;
            display: none;
        }
        
        .tile span { pointer-events: none; z-index: 12; text-shadow: 1px 1px 3px black; }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -2px); }
            100% { transform: translate(1px, -1px); }
        }

        /* --- ALT PANEL --- */
        #footer {
            background: var(--panel); padding: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 101;
        }
        .btn-row { display: flex; gap: 5px; }
        button.action-btn {
            flex: 1; padding: 10px; border: none; border-radius: 6px;
            font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); font-size:12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        button.action-btn:active { transform: translateY(2px); box-shadow: none; }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-green { background: #27ae60; }
        .btn-orange { background: #e67e22; }
        .btn-purp { background: #8e44ad; }
        .btn-trap { background: #34495e; border: 1px solid #3498db; }
        
        .cd-overlay {
            position: absolute; bottom: 0; left: 0; height: 4px; width: 0%;
            background: rgba(255,255,255,0.7); transition: width 0.1s linear;
        }

        /* --- MODALLAR --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; padding: 20px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center; border: 1px solid #444;
            max-height: 85vh; overflow-y: auto;
        }
        
        .list-item {
            background: #333; padding: 10px; margin: 5px 0; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        
        .color-opt { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 5px;}

        @keyframes pop { 50% { transform: scale(1.4); filter: brightness(1.5); } }
        .anim-pop { animation: pop 0.2s ease-out; z-index: 15 !important; }

        .float-text {
            position: absolute; color: var(--gold); font-weight: bold; font-size: 18px;
            pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 20;
            text-shadow: 0 0 3px black;
        }
        .float-text.bad { color: var(--barb); font-size: 22px; z-index: 25; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-50px); opacity:0; } }

        #pause-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1500; flex-direction:column; justify-content:center; align-items:center; color:white; backdrop-filter: blur(3px); }

    </style>
</head>
<body>

    <div id="header">
        <div class="header-left">
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn btn-help" onclick="openModal('help-modal')">?</button>
            <button class="icon-btn btn-skin" onclick="openModal('skin-modal')">üé®</button>
            <button class="icon-btn btn-quest" onclick="openMissions()">üìú</button>
        </div>
        <div class="header-right">
            <span class="badge">üí∞ <span id="ui-gold" class="gold-txt">0</span></span>
            <button class="icon-btn" onclick="togglePause()">‚è∏</button>
        </div>
    </div>

    <div id="game-container">
        <div id="map-grid"></div>
        <div id="pause-overlay">
            <h3>OYUN DURAKLATILDI</h3>
            <button class="action-btn btn-green" style="width:120px; flex:none;" onclick="togglePause()">DEVAM ET</button>
        </div>
        <svg id="arrow-layer">
            <line id="drag-line" x1="0" y1="0" x2="0" y2="0" stroke="#f1c40f" stroke-width="12" stroke-linecap="round" style="display:none; opacity: 0.9;" />
            <polygon id="drag-head" points="0,0" fill="#f1c40f" style="display:none;" />
        </svg>
    </div>

    <div id="footer">
        <div class="btn-row">
            <button class="action-btn btn-green" onclick="recruitAction()">+ ASKER (5g)</button>
            <button class="action-btn btn-trap" onclick="setTrap()">ü™§ PUSU KUR (15g)</button>
            <button class="action-btn btn-orange" onclick="openModal('shop-modal')">üõí MAƒûAZA</button>
        </div>
        <div class="btn-row">
            <button id="btn-tax" class="action-btn btn-purp" onclick="collectTax()">
                <span>VERGƒ∞: +<span id="ui-income">0</span>g</span>
                <span style="font-size:10px; color:#ddd;">Halk Desteƒüi: %<span id="ui-efficiency">100</span></span>
                <div class="cd-overlay" id="tax-cd"></div>
            </button>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:#3498db;">YENƒ∞ EKONOMƒ∞ Sƒ∞STEMƒ∞</h3>
            <div style="text-align:left; font-size:13px; line-height:1.5;">
                <p>üìâ <strong>Vergi Yorgunluƒüu:</strong> S√ºrekli vergi toplarsan Halk Desteƒüi d√º≈üer ve paran azalƒ±r.</p>
                <p>‚öîÔ∏è <strong>Fetih Bonusu:</strong> Yeni yerler fethettik√ße Halk Desteƒüi tekrar artar.</p>
                <p>üíé <strong>Zenginlik:</strong> Her b√∂lgenin ekonomisi farklƒ±dƒ±r. Daha √ßok b√∂lge = Daha √ßok potansiyel gelir.</p>
                <p>üíÄ <strong>Pusular:</strong> Tarafsƒ±z b√∂lgelerde barbarlara dikkat et!</p>
            </div>
            <button class="action-btn btn-green" onclick="closeModal('help-modal')">ANLADIM</button>
        </div>
    </div>

    <div id="missions-modal" class="modal"><div class="modal-content"><h3 style="color:#8e44ad;">G√ñREVLER</h3><div id="mission-list"></div><br><button class="action-btn btn-green" onclick="closeModal('missions-modal')">KAPAT</button></div></div>

    <div id="skin-modal" class="modal">
        <div class="modal-content">
            <h3>√ñZELLE≈ûTƒ∞RME</h3>
            <p>Senin Rengin:</p>
            <div><span class="color-opt" style="background:#3498db" onclick="setSkin('player', '#3498db')"></span><span class="color-opt" style="background:#1abc9c" onclick="setSkin('player', '#1abc9c')"></span><span class="color-opt" style="background:#9b59b6" onclick="setSkin('player', '#9b59b6')"></span></div>
            <p>D√º≈üman Rengi:</p>
            <div><span class="color-opt" style="background:#c0392b" onclick="setSkin('enemy', '#c0392b')"></span><span class="color-opt" style="background:#e67e22" onclick="setSkin('enemy', '#e67e22')"></span><span class="color-opt" style="background:#2c3e50" onclick="setSkin('enemy', '#2c3e50')"></span></div>
            <p>Barbar Rengi:</p>
            <div><span class="color-opt" style="background:#d35400" onclick="setSkin('barb', '#d35400')"></span><span class="color-opt" style="background:#8e44ad" onclick="setSkin('barb', '#8e44ad')"></span><span class="color-opt" style="background:#2ecc71" onclick="setSkin('barb', '#2ecc71')"></span><span class="color-opt" style="background:#000000" onclick="setSkin('barb', '#000000')"></span></div>
            <br><button class="action-btn btn-green" onclick="closeModal('skin-modal')">KAYDET</button>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-content"><h3 style="color:#e67e22;">Sƒ∞LAH T√úCCARI</h3>
            <div class="list-item" onclick="buyItem('income')"><div>üìà <strong>Yatƒ±rƒ±m</strong><br><small>Gelir +3 Artar</small></div><div style="color:var(--gold)">50g</div></div>
            <div class="list-item" onclick="buyItem('merc')"><div>‚öîÔ∏è <strong>Paralƒ± Asker</strong><br><small>Se√ßili yere +15 Asker</small></div><div style="color:var(--gold)">40g</div></div>
            <div class="list-item" onclick="buyItem('fort')"><div>üè∞ <strong>Kale</strong><br><small>Merkeze +25 Asker</small></div><div style="color:var(--gold)">60g</div></div>
            <div class="list-item" onclick="buyItem('spy')"><div>üëÅÔ∏è <strong>Casus</strong><br><small>Pusularƒ± G√∂sterir</small></div><div style="color:var(--gold)">75g</div></div>
            <div class="list-item" onclick="buyItem('nuke')"><div>üí£ <strong>Hava Saldƒ±rƒ±sƒ±</strong><br><small>D√º≈üman ordularƒ±nƒ± vur</small></div><div style="color:var(--gold)">120g</div></div>
            <br><button class="action-btn btn-blue" onclick="closeModal('shop-modal')">√áIKI≈û</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content"><h3>AYARLAR</h3><div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;"><p style="margin:0 0 5px 0; font-size:12px; color:#aaa;">Hƒ∞LE KODU:</p><input type="text" id="cheat-code" style="width:70%; padding:8px; text-transform:uppercase;" placeholder="KOD"><button class="action-btn btn-purp" style="padding:8px; width:auto;" onclick="submitCode()">OK</button></div><button class="action-btn" style="background:#c0392b;" onclick="fullReset()">‚ö†Ô∏è OYUNU SIFIRLA</button><br><br><button class="action-btn btn-green" onclick="closeModal('settings-modal')">KAPAT</button></div>
    </div>

<script>
    const GRID_W = 8;
    const TOTAL = GRID_W * GRID_W;
    
    let gold = 0;
    let level = 1;
    let incomeBonus = 0;
    let tiles = []; 
    let isPaused = false;
    let dragStartIdx = null;
    let isDragging = false;
    let selectedIdx = null;
    let taxReady = true;
    
    // YENƒ∞ DEƒûƒ∞≈ûKEN: Vergi Verimliliƒüi (Halk Desteƒüi)
    let taxEfficiency = 100; 

    let missions = { kill: { target: 20, current: 0, desc: "D√º≈üman √ñld√ºr", reward: 30 }, conquer: { target: 5, current: 0, desc: "B√∂lge Fethet", reward: 40 } };
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext();

    function playSound(type) {
        if(isPaused) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'coin') { osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.05, now); osc.frequency.linearRampToValueAtTime(1800, now+0.1); gain.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1); }
        else if (type === 'fight') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.2); osc.start(now); osc.stop(now+0.2); }
        else if (type === 'ambush') { osc.type = 'square'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.1, now); osc.frequency.linearRampToValueAtTime(50, now+0.4); gain.gain.linearRampToValueAtTime(0, now+0.4); osc.start(now); osc.stop(now+0.4); }
    }

    function init(nextLevel = false) {
        document.getElementById('map-grid').innerHTML = '';
        tiles = [];
        isPaused = false;
        document.getElementById('pause-overlay').style.display = 'none';
        
        if(!nextLevel) {
            const d = JSON.parse(localStorage.getItem('aos_v10_save')) || {};
            level = d.level || 1; gold = d.gold || 0; incomeBonus = d.income || 0;
            if(d.missions) missions = d.missions;
            if(d.colors) {
                document.documentElement.style.setProperty('--player', d.colors.player);
                document.documentElement.style.setProperty('--enemy', d.colors.enemy);
                if(d.colors.barb) document.documentElement.style.setProperty('--barb', d.colors.barb);
            }
        }
        
        // Yeni b√∂l√ºmde vergi verimliliƒüini sƒ±fƒ±rla
        taxEfficiency = 100;

        for (let i = 0; i < TOTAL; i++) {
            let owner = 0;
            let army = Math.floor(Math.random() * 3) + 1;
            // YENƒ∞: Her karenin ekonomik deƒüeri (1-3 arasƒ±)
            let economy = Math.floor(Math.random() * 3) + 1;
            let hiddenBarb = 0;

            if (i === 0) { owner = 1; army = 15; } 
            else if (i === TOTAL - 1) { owner = 2; army = 20 + (level * 8); } 
            else { if(Math.random() < 0.15) hiddenBarb = 10 + (level * 2); }

            const div = document.createElement('div');
            div.className = 'tile neutral';
            div.dataset.idx = i;
            div.innerHTML = `<span>${army}</span><div class="trap-indicator"></div>`;
            div.addEventListener('mousedown', startDrag);
            div.addEventListener('touchstart', startDrag, {passive: false});

            document.getElementById('map-grid').appendChild(div);
            tiles.push({ id: i, owner, army, economy: economy, trap: 0, hiddenBarb: hiddenBarb, el: div });
        }
        
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchmove', doDrag, {passive: false});
        window.addEventListener('touchend', endDrag);

        updateUI();
        startGameLoops();
    }

    let loops = {};
    function startGameLoops() {
        for(let k in loops) clearInterval(loops[k]);
        loops.ai = setInterval(() => { if(!isPaused) aiLoop(); }, Math.max(500, 2000 - (level * 100)));
        loops.spawn = setInterval(() => { if(!isPaused && tiles[0].owner===1) { tiles[0].army+=2; animPop(0); updateUI(); } }, 4000);
    }

    // --- OYNANI≈û ---
    function attemptMove(from, to) {
        if(isPaused) return;
        const r1 = Math.floor(from/GRID_W), c1 = from%GRID_W;
        const r2 = Math.floor(to/GRID_W), c2 = to%GRID_W;
        if(Math.abs(r1-r2) + Math.abs(c1-c2) !== 1) return;

        const src = tiles[from];
        const dest = tiles[to];
        if(src.army <= 1) return;

        let force = Math.floor(src.army / 2);
        src.army -= force;

        if(dest.owner === 1) {
            dest.army += force; 
        } else {
            if(dest.owner === 0 && dest.hiddenBarb > 0) {
                playSound('ambush');
                dest.army += dest.hiddenBarb; dest.hiddenBarb = 0; dest.owner = 3; dest.el.classList.add('barbarian');
                showFloatText("‚ö†Ô∏è PUSU!", dest.el, 'bad');
                if(force > dest.army) {
                    dest.army = force - dest.army; dest.owner = 1; dest.el.classList.remove('barbarian');
                    missionUpdate('kill', 5); missionUpdate('conquer', 1);
                    boostTaxEfficiency(); // Fetih Bonusu
                } else { dest.army -= force; }
            } else {
                if(force > dest.army) {
                    missionUpdate('kill', dest.army);
                    dest.army = force - dest.army; dest.owner = 1; dest.trap = 0; dest.hiddenBarb = 0;
                    playSound('fight');
                    missionUpdate('conquer', 1);
                    boostTaxEfficiency(); // Fetih Bonusu
                    checkWin();
                } else {
                    missionUpdate('kill', force); dest.army -= force; playSound('fight');
                }
            }
        }
        updateUI();
    }

    function aiLoop() {
        if(isPaused) return;
        const units = tiles.filter(t => t.owner === 2);
        units.forEach(t => {
            if(Math.random() > 0.3 && t.army > 2) {
                const adj = [t.id-1, t.id+1, t.id-GRID_W, t.id+GRID_W].filter(n => n>=0 && n<TOTAL);
                const targetId = adj.find(n => tiles[n] && (Math.abs((t.id%GRID_W)-(n%GRID_W))+Math.abs(Math.floor(t.id/GRID_W)-Math.floor(n/GRID_W))===1));
                if(targetId !== undefined) {
                    const target = tiles[targetId];
                    if(target.owner !== 2) {
                        const force = Math.floor(t.army/2); t.army -= force;
                        if(target.owner === 0 && target.trap > 0) {
                            if(target.trap > force) { target.owner = 1; target.army = target.trap - force; target.trap = 0; showFloatText("Pusu Tuttu!", target.el); } 
                            else { target.owner = 2; target.army = force - target.trap; target.trap = 0; }
                        } else {
                            if(force > target.army) { target.army = force - target.army; target.owner = 2; checkWin(); } else { target.army -= force; }
                        }
                    }
                }
            } else { t.army += 1 + Math.floor(level/5); }
        });
        updateUI();
    }

    // --- VERGƒ∞ VE EKONOMƒ∞ Sƒ∞STEMƒ∞ (G√úNCELLENDƒ∞) ---
    function collectTax() {
        if(!taxReady || isPaused) return;
        
        // 1. Oyuncunun toplam ekonomik deƒüerini hesapla
        const playerTiles = tiles.filter(t => t.owner === 1);
        let baseIncome = playerTiles.reduce((sum, tile) => sum + tile.economy, 0) + incomeBonus + 5;
        
        // 2. Vergi Verimliliƒüi (Halk Desteƒüi) ile √ßarp
        let finalIncome = Math.floor(baseIncome * (taxEfficiency / 100));
        
        gold += finalIncome;
        playSound('coin');
        showFloatText(`+${finalIncome}g`, document.getElementById('btn-tax'));
        
        // 3. Verimliliƒüi d√º≈ü√ºr (Anti-Camping)
        taxEfficiency -= 15;
        if(taxEfficiency < 10) taxEfficiency = 10; // Min %10
        
        taxReady = false;
        document.getElementById('btn-tax').disabled = true;
        let w=0; 
        let int = setInterval(()=>{
            if(!isPaused) { w+=5; document.getElementById('tax-cd').style.width=w/20+"%"; if(w>=2000){clearInterval(int); taxReady=true; document.getElementById('btn-tax').disabled=false;} }
        }, 10);
        updateUI();
    }

    function boostTaxEfficiency() {
        // Fetih yapƒ±nca halk desteƒüi artar
        taxEfficiency += 25;
        if(taxEfficiency > 100) taxEfficiency = 100;
        showFloatText("Destek Arttƒ±! üìà", document.body, 'green');
    }

    function recruitAction() {
        if(isPaused) return;
        if(selectedIdx===null || tiles[selectedIdx].owner!==1) return;
        if(gold<5)return;
        gold-=5; tiles[selectedIdx].army+=5; animPop(selectedIdx); updateUI();
    }
    
    function setTrap() {
        if(isPaused) return;
        if(selectedIdx === null || tiles[selectedIdx].owner !== 0) return alert("Tarafsƒ±z b√∂lge se√ß!");
        if(gold < 15) return;
        gold-=15; tiles[selectedIdx].trap += 5; 
        showFloatText("ü™§ Gizlendi", tiles[selectedIdx].el); updateUI();
    }

    // --- G√ñREV & MAƒûAZA & UI ---
    function missionUpdate(type, amt) {
        if(missions[type] && missions[type].current < missions[type].target) {
            missions[type].current += amt;
            if(missions[type].current >= missions[type].target) {
                gold += missions[type].reward;
                showFloatText("G√ñREV TAMAM!", document.body);
                missions[type].target = Math.floor(missions[type].target * 1.5); missions[type].current = 0;
            }
        }
    }
    function openMissions() {
        let html = '';
        for(let k in missions) {
            let m = missions[k];
            html += `<div class="list-item"><div>${m.desc}<br><small>${m.current} / ${m.target}</small></div><div style="color:var(--gold)">+${m.reward}g</div></div>`;
        }
        document.getElementById('mission-list').innerHTML = html; openModal('missions-modal');
    }
    function buyItem(type) {
        if(type==='income' && gold>=50) { gold-=50; incomeBonus+=3; }
        else if(type==='merc' && gold>=40) { if(selectedIdx!==null && tiles[selectedIdx].owner===1){gold-=40; tiles[selectedIdx].army+=15;} }
        else if(type==='nuke' && gold>=120) { gold-=120; tiles.forEach(t=>{if(t.owner===2)t.army=1}); playSound('fight'); }
        else if(type==='fort' && gold>=60) { if(tiles[0].owner===1) { gold-=60; tiles[0].army+=25; } }
        else if(type==='spy' && gold>=75) { gold-=75; tiles.forEach(t => { if(t.hiddenBarb > 0) { t.el.classList.add('revealed'); setTimeout(()=>t.el.classList.remove('revealed'), 3000); } }); showFloatText("üëÅÔ∏è Pusular G√∂r√ºnd√º", document.body); }
        closeModal('shop-modal'); updateUI();
    }
    function setSkin(who, color) { document.documentElement.style.setProperty('--' + who, color); saveData(); }

    function updateUI() {
        document.getElementById('ui-gold').innerText = gold;
        
        // Tahmini Gelir G√∂stergesi
        const playerTiles = tiles.filter(t => t.owner === 1);
        let baseIncome = playerTiles.reduce((sum, t) => sum + t.economy, 0) + incomeBonus + 5;
        let predictedIncome = Math.floor(baseIncome * (taxEfficiency / 100));
        
        document.getElementById('ui-income').innerText = predictedIncome;
        document.getElementById('ui-efficiency').innerText = taxEfficiency;
        
        // Verimlilik rengi
        let effEl = document.getElementById('ui-efficiency');
        if(taxEfficiency > 70) effEl.style.color = "#2ecc71";
        else if(taxEfficiency > 30) effEl.style.color = "#f1c40f";
        else effEl.style.color = "#e74c3c";

        tiles.forEach(t => {
            const el = t.el; el.className = 'tile';
            if(t.owner===1) el.classList.add('player'); else if(t.owner===2) el.classList.add('enemy'); else if(t.owner===3) el.classList.add('barbarian'); else el.classList.add('neutral');
            const trap = el.querySelector('.trap-indicator'); trap.style.display = (t.trap > 0 && t.owner===0) ? 'block' : 'none';
            if(selectedIdx===t.id) el.style.border="2px solid white"; else el.style.border="";
            el.querySelector('span').innerText = t.army;
        });
        saveData();
    }
    function saveData() {
        const colors = { player: getComputedStyle(document.documentElement).getPropertyValue('--player').trim(), enemy: getComputedStyle(document.documentElement).getPropertyValue('--enemy').trim(), barb: getComputedStyle(document.documentElement).getPropertyValue('--barb').trim() };
        localStorage.setItem('aos_v10_save', JSON.stringify({level, gold, income:incomeBonus, missions, colors}));
    }
    function checkWin() { if(tiles.filter(t=>t.owner===1).length===0) { alert("YENƒ∞LDƒ∞N"); init(false); } else if(tiles.filter(t=>t.owner===2).length===0) { alert("ZAFER!"); level++; init(true); } }

    function togglePause(){ isPaused=!isPaused; document.getElementById('pause-overlay').style.display=isPaused?'flex':'none'; }
    function openModal(id){ document.getElementById(id).style.display='flex'; isPaused=true; }
    function closeModal(id){ document.getElementById(id).style.display='none'; isPaused=false; }
    function openSettings(){ openModal('settings-modal'); }
    function fullReset(){ localStorage.removeItem('aos_v10_save'); location.reload(); }
    function submitCode(){ const val = document.getElementById('cheat-code').value.trim().toUpperCase(); if(val==='PARA'){ gold+=500; updateUI(); closeModal('settings-modal'); } else if(val==='LEVEL'){ level++; init(true); closeModal('settings-modal'); } else {alert("Kod Hatalƒ±");} }
    function showFloatText(txt,t,c){ if(!t)return; const r=t.getBoundingClientRect?t.getBoundingClientRect():{top:100,left:100}; const e=document.createElement('div'); e.className='float-text '+(c||''); e.innerText=txt; e.style.left=r.left+'px'; e.style.top=r.top+'px'; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
    function animPop(i){ tiles[i].el.classList.remove('anim-pop'); void tiles[i].el.offsetWidth; tiles[i].el.classList.add('anim-pop'); }

    function startDrag(e){if(isPaused)return; if(e.target.closest('.tile')){e.preventDefault();const i=parseInt(e.target.closest('.tile').dataset.idx); if(tiles[i].owner===1||tiles[i].owner===0){selectedIdx=i;updateUI();} if(tiles[i].owner===1){isDragging=true;dragStartIdx=i;}}}
    function doDrag(e){if(!isDragging||isPaused)return;e.preventDefault();const t=e.touches?e.touches[0]:e;const b=tiles[dragStartIdx].el.getBoundingClientRect();drawArrow(b.left+b.width/2,b.top+b.height/2,t.clientX,t.clientY);}
    function endDrag(e){if(!isDragging)return;isDragging=false;document.getElementById('drag-line').style.display='none';document.getElementById('drag-head').style.display='none';const t=e.changedTouches?e.changedTouches[0]:e;const el=document.elementFromPoint(t.clientX,t.clientY);if(el&&el.closest('.tile')){const i=parseInt(el.closest('.tile').dataset.idx);if(i!==dragStartIdx)attemptMove(dragStartIdx,i);}}
    function drawArrow(x1,y1,x2,y2){const l=document.getElementById('drag-line'),h=document.getElementById('drag-head');l.style.display='block';l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);const a=Math.atan2(y2-y1,x2-x1);h.style.display='block';h.setAttribute('points',`${x2},${y2} ${x2-20*Math.cos(a-0.5)},${y2-20*Math.sin(a-0.5)} ${x2-20*Math.cos(a+0.5)},${y2-20*Math.sin(a+0.5)}`);}

    init();
</script>
</body>
</html>