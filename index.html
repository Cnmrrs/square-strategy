<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Square Strategy: Warlord</title>
    <style>
        /* --- ORTALAMA D√úZELTMESƒ∞ ƒ∞√áƒ∞N EKLENEN SATIR --- */
        * { box-sizing: border-box; }

        :root {
            --bg: #121212;
            --panel: #1e272e;
            --player: #3498db;
            --enemy: #c0392b;
            --barb: #d35400;
            --gold: #f1c40f;
            --text: #ecf0f1;
            --green: #2ecc71;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw; /* Tam geni≈ülik */
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- √úST PANEL --- */
        #header {
            background: var(--panel);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-size: 13px;
            z-index: 100;
            width: 100%; /* Tam geni≈ülik */
        }
        .header-left, .header-right { display: flex; gap: 5px; align-items: center; }
        
        .badge { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 11px;}
        .gold-txt { color: var(--gold); }
        .tactic-badge { border: 1px solid #777; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .icon-btn {
            background: #444; border: none; color: white; border-radius: 5px;
            width: 32px; height: 32px; cursor: pointer; font-size: 16px; 
            display:flex; justify-content:center; align-items:center;
            transition: 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        .btn-help { background: #2980b9; }
        .btn-quest { background: #8e44ad; position: relative; }
        .quest-alert { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: red; border-radius: 50%; display: none; }
        .btn-skin { background: #16a085; }

        /* --- OYUN ALANI (D√úZELTƒ∞LDƒ∞) --- */
        #game-container {
            flex: 1;
            width: 100%; /* Kapsayƒ±cƒ± tam geni≈ülik */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center; /* Tam ortalama */
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            width: 95vw; /* Mobilde kenarlara yapƒ±≈ümasƒ±n */
            max-width: 500px;
            aspect-ratio: 1/1;
            position: relative;
            z-index: 10;
            margin: auto; /* Ekstra g√ºvenlik i√ßin margin auto */
        }

        .tile {
            background: #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.6);
            position: relative;
            transition: transform 0.1s, background 0.2s;
        }
        
        .tile.player { background: var(--player); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.enemy { background: var(--enemy); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.barbarian { background: var(--barb); border-bottom: 3px solid rgba(0,0,0,0.3); animation: shake 0.5s; }
        .tile.neutral { background: #555; opacity: 0.7; }

        .tile.revealed { border: 2px solid var(--barb); }
        .trap-indicator {
            position: absolute; bottom: 2px; right: 2px;
            width: 6px; height: 6px; background: cyan;
            border-radius: 50%; box-shadow: 0 0 4px white;
            display: none;
        }
        .tile span { pointer-events: none; z-index: 12; text-shadow: 1px 1px 3px black; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }

        /* --- ALT PANEL --- */
        #footer {
            background: var(--panel); padding: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 101; width: 100%;
        }
        .btn-row { display: flex; gap: 5px; }
        button.action-btn {
            flex: 1; padding: 10px; border: none; border-radius: 6px;
            font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); font-size:12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        button.action-btn:active { transform: translateY(2px); box-shadow: none; }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-green { background: #27ae60; }
        .btn-orange { background: #e67e22; }
        .btn-purp { background: #8e44ad; }
        .btn-red { background: #c0392b; } 
        .btn-trap { background: #34495e; border: 1px solid #3498db; }
        
        .cd-overlay {
            position: absolute; bottom: 0; left: 0; height: 4px; width: 0%;
            background: rgba(255,255,255,0.7); transition: width 0.1s linear;
        }

        /* --- MODALLAR --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; padding: 20px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center; border: 1px solid #444;
            max-height: 85vh; overflow-y: auto;
        }
        
        .list-item {
            background: #333; padding: 10px; margin: 5px 0; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .prog-bar {
            width: 100%; height: 6px; background: #555; border-radius: 3px; margin-top: 5px; overflow: hidden;
        }
        .prog-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        .tactic-card {
            border: 2px solid #444; padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; text-align: left;
            transition: 0.2s;
        }
        .tactic-card.active { border-color: var(--gold); background: rgba(241, 196, 15, 0.1); }
        .tactic-title { font-weight: bold; margin-bottom: 2px; }
        .tactic-desc { font-size: 11px; color: #aaa; }

        .color-opt { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 5px;}

        @keyframes pop { 50% { transform: scale(1.4); filter: brightness(1.5); } }
        .anim-pop { animation: pop 0.2s ease-out; z-index: 15 !important; }

        .float-text {
            position: absolute; color: var(--gold); font-weight: bold; font-size: 18px;
            pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 20;
            text-shadow: 0 0 3px black;
        }
        .float-text.bad { color: var(--barb); font-size: 22px; z-index: 25; }
        .float-text.green { color: var(--green); font-size: 20px; z-index: 25; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-50px); opacity:0; } }

        #pause-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1500; flex-direction:column; justify-content:center; align-items:center; color:white; backdrop-filter: blur(3px); }

    </style>
</head>
<body>

    <div id="header">
        <div class="header-left">
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn btn-help" onclick="openModal('help-modal')">?</button>
            <button class="icon-btn btn-skin" onclick="openModal('skin-modal')">üé®</button>
            <button class="icon-btn btn-quest" onclick="openMissions()">
                üìú<div class="quest-alert" id="quest-alert"></div>
            </button>
        </div>
        <div class="header-right">
            <span class="badge tactic-badge" id="ui-tactic-badge">NORMAL</span>
            <span class="badge">üí∞ <span id="ui-gold" class="gold-txt">0</span></span>
            <button class="icon-btn" onclick="togglePause()">‚è∏</button>
        </div>
    </div>

    <div id="game-container">
        <div id="map-grid"></div>
        <div id="pause-overlay">
            <h3>OYUN DURAKLATILDI</h3>
            <button class="action-btn btn-green" style="width:120px; flex:none;" onclick="togglePause()">DEVAM ET</button>
        </div>
        <svg id="arrow-layer">
            <line id="drag-line" x1="0" y1="0" x2="0" y2="0" stroke="#f1c40f" stroke-width="12" stroke-linecap="round" style="display:none; opacity: 0.9;" />
            <polygon id="drag-head" points="0,0" fill="#f1c40f" style="display:none;" />
        </svg>
    </div>

    <div id="footer">
        <div class="btn-row">
            <button class="action-btn btn-red" onclick="openModal('tactic-modal')">‚öîÔ∏è TAKTƒ∞K</button>
            <button class="action-btn btn-trap" onclick="setTrap()">ü™§ PUSU (15g)</button>
            <button class="action-btn btn-orange" onclick="openModal('shop-modal')">üõí MAƒûAZA</button>
        </div>
        <div class="btn-row">
            <button id="btn-recruit" class="action-btn btn-green" onclick="recruitAction()">+ ASKER (<span id="ui-recruit-cost">5</span>g)</button>
            <button id="btn-tax" class="action-btn btn-purp" onclick="collectTax()">
                <span>VERGƒ∞: +<span id="ui-income">0</span>g</span>
                <span style="font-size:10px; color:#ddd;">Halk Desteƒüi: %<span id="ui-efficiency">100</span></span>
                <div class="cd-overlay" id="tax-cd"></div>
            </button>
        </div>
    </div>

    <div id="missions-modal" class="modal"><div class="modal-content"><h3 style="color:#8e44ad;">G√úNL√úK G√ñREVLER</h3><p style="font-size:11px; color:#aaa;" id="mission-timer">Yenilenme: Yarƒ±n</p><div id="mission-list"></div><br><button class="action-btn btn-green" onclick="closeModal('missions-modal')">KAPAT</button></div></div>
    <div id="tactic-modal" class="modal"><div class="modal-content"><h3 style="color:#c0392b;">SAVA≈û DOKTRƒ∞Nƒ∞</h3><div class="tactic-card" id="tac-normal" onclick="setTactic('normal')"><div class="tactic-title">‚ö™ NORMAL</div><div class="tactic-desc">Dengeli. Bonus veya ceza yok.</div></div><div class="tactic-card" id="tac-attack" onclick="setTactic('attack')"><div class="tactic-title">üî¥ TAARRUZ (H√ºcum)</div><div class="tactic-desc">Saldƒ±rƒ± G√ºc√º: <strong>+%50</strong><br>Savunma Zafiyeti: <strong>Alƒ±nan hasar artar.</strong></div></div><div class="tactic-card" id="tac-defense" onclick="setTactic('defense')"><div class="tactic-title">üîµ TAHKƒ∞MAT (Savunma)</div><div class="tactic-desc">Savunma G√ºc√º: <strong>+%50</strong><br>Saldƒ±rƒ± Cezasƒ±: <strong>-%30 Hasar.</strong></div></div><div class="tactic-card" id="tac-speed" onclick="setTactic('speed')"><div class="tactic-title">üü¢ LOJƒ∞STƒ∞K (Ekonomi)</div><div class="tactic-desc">Asker Maliyeti: <strong>4g</strong> (Ucuz)<br>Sava≈ü G√ºc√º: <strong>-%20 Hasar.</strong></div></div><br><button class="action-btn btn-green" onclick="closeModal('tactic-modal')">ONAYLA</button></div></div>
    <div id="help-modal" class="modal"><div class="modal-content"><h3 style="color:#3498db;">YENƒ∞ MEKANƒ∞KLER</h3><div style="text-align:left;font-size:13px;"><p>üìä <strong>Dinamik Halk:</strong> B√ºy√ºk ordularƒ± yenersen halk co≈üar (%40 destek). Kaybedersen d√º≈üer. S√ºrekli vergi toplarsan d√º≈üer.</p><p>‚öîÔ∏è <strong>Taktikler:</strong> Alt men√ºden stratejini se√ß. Saldƒ±rƒ±, Savunma veya Ucuz Asker.</p><p>üìÖ <strong>G√ºnl√ºk G√∂rev:</strong> Her g√ºn 6 yeni g√∂rev gelir.</p></div><button class="action-btn btn-green" onclick="closeModal('help-modal')">ANLADIM</button></div></div>
    <div id="skin-modal" class="modal"><div class="modal-content"><h3>√ñZELLE≈ûTƒ∞RME</h3><p>Sen:</p><div><span class="color-opt" style="background:#3498db" onclick="setSkin('player', '#3498db')"></span><span class="color-opt" style="background:#1abc9c" onclick="setSkin('player', '#1abc9c')"></span><span class="color-opt" style="background:#9b59b6" onclick="setSkin('player', '#9b59b6')"></span></div><p>D√º≈üman:</p><div><span class="color-opt" style="background:#c0392b" onclick="setSkin('enemy', '#c0392b')"></span><span class="color-opt" style="background:#e67e22" onclick="setSkin('enemy', '#e67e22')"></span></div><p>Barbar:</p><div><span class="color-opt" style="background:#d35400" onclick="setSkin('barb', '#d35400')"></span><span class="color-opt" style="background:#8e44ad" onclick="setSkin('barb', '#8e44ad')"></span></div><br><button class="action-btn btn-green" onclick="closeModal('skin-modal')">KAYDET</button></div></div>
    <div id="shop-modal" class="modal"><div class="modal-content"><h3 style="color:#e67e22;">MAƒûAZA</h3><div class="list-item" onclick="buyItem('income')"><div>üìà <strong>Yatƒ±rƒ±m</strong><br><small>Gelir +3</small></div><div style="color:var(--gold)">50g</div></div><div class="list-item" onclick="buyItem('merc')"><div>‚öîÔ∏è <strong>Paralƒ± Asker</strong><br><small>+15 Asker</small></div><div style="color:var(--gold)">40g</div></div><div class="list-item" onclick="buyItem('fort')"><div>üè∞ <strong>Kale</strong><br><small>Merkez +25 Asker</small></div><div style="color:var(--gold)">60g</div></div><div class="list-item" onclick="buyItem('spy')"><div>üëÅÔ∏è <strong>Casus</strong><br><small>Pusularƒ± G√∂r</small></div><div style="color:var(--gold)">75g</div></div><div class="list-item" onclick="buyItem('nuke')"><div>üí£ <strong>Hava Saldƒ±rƒ±sƒ±</strong><br><small>D√º≈ümanƒ± Vur</small></div><div style="color:var(--gold)">120g</div></div><br><button class="action-btn btn-blue" onclick="closeModal('shop-modal')">√áIKI≈û</button></div></div>
    <div id="settings-modal" class="modal"><div class="modal-content"><h3>AYARLAR</h3><div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;"><input type="text" id="cheat-code" style="width:70%; padding:8px; text-transform:uppercase;" placeholder="KOD"><button class="action-btn btn-purp" style="padding:8px; width:auto;" onclick="submitCode()">OK</button></div><button class="action-btn" style="background:#c0392b;" onclick="fullReset()">‚ö†Ô∏è SIFIRLA</button><br><br><button class="action-btn btn-green" onclick="closeModal('settings-modal')">KAPAT</button></div></div>

<script>
    const GRID_W = 8;
    const TOTAL = GRID_W * GRID_W;
    
    let gold = 0;
    let level = 1;
    let incomeBonus = 0;
    let tiles = []; 
    let isPaused = false;
    let dragStartIdx = null;
    let isDragging = false;
    let selectedIdx = null;
    let taxReady = true;
    let taxEfficiency = 100;
    
    // STRATEJƒ∞
    let currentTactic = 'normal'; 

    // G√ñREVLER
    let dailyMissions = [];
    let lastMissionDate = "";

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext();

    function playSound(type) {
        if(isPaused) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'coin') { osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.05, now); osc.frequency.linearRampToValueAtTime(1800, now+0.1); gain.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1); }
        else if (type === 'fight') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.2); osc.start(now); osc.stop(now+0.2); }
        else if (type === 'ambush') { osc.type = 'square'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.1, now); osc.frequency.linearRampToValueAtTime(50, now+0.4); gain.gain.linearRampToValueAtTime(0, now+0.4); osc.start(now); osc.stop(now+0.4); }
        else if (type === 'good') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.1, now); osc.frequency.exponentialRampToValueAtTime(800, now+0.3); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); }
    }

    function init(nextLevel = false) {
        document.getElementById('map-grid').innerHTML = '';
        tiles = [];
        isPaused = false;
        document.getElementById('pause-overlay').style.display = 'none';
        
        if(!nextLevel) {
            const d = JSON.parse(localStorage.getItem('aos_pro_save')) || {};
            level = d.level || 1; gold = d.gold || 0; incomeBonus = d.income || 0;
            if(d.date) lastMissionDate = d.date;
            if(d.missions) dailyMissions = d.missions;
            if(d.colors) {
                document.documentElement.style.setProperty('--player', d.colors.player);
                document.documentElement.style.setProperty('--enemy', d.colors.enemy);
                if(d.colors.barb) document.documentElement.style.setProperty('--barb', d.colors.barb);
            }
        }
        
        checkDailyMissions();
        taxEfficiency = 100;

        for (let i = 0; i < TOTAL; i++) {
            let owner = 0;
            let army = Math.floor(Math.random() * 3) + 1;
            let economy = Math.floor(Math.random() * 3) + 1;
            let hiddenBarb = 0;

            if (i === 0) { owner = 1; army = 15; } 
            else if (i === TOTAL - 1) { owner = 2; army = 20 + (level * 8); } 
            else { if(Math.random() < 0.15) hiddenBarb = 10 + (level * 2); }

            const div = document.createElement('div');
            div.className = 'tile neutral';
            div.dataset.idx = i;
            div.innerHTML = `<span>${army}</span><div class="trap-indicator"></div>`;
            div.addEventListener('mousedown', startDrag);
            div.addEventListener('touchstart', startDrag, {passive: false});

            document.getElementById('map-grid').appendChild(div);
            tiles.push({ id: i, owner, army, economy: economy, trap: 0, hiddenBarb: hiddenBarb, el: div });
        }
        
        window.addEventListener('mousemove', doDrag);
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchmove', doDrag, {passive: false});
        window.addEventListener('touchend', endDrag);

        setTactic('normal'); 
        updateUI();
        startGameLoops();
    }

    let loops = {};
    function startGameLoops() {
        for(let k in loops) clearInterval(loops[k]);
        loops.ai = setInterval(() => { if(!isPaused) aiLoop(); }, Math.max(500, 2000 - (level * 100)));
        loops.spawn = setInterval(() => { if(!isPaused && tiles[0].owner===1) { tiles[0].army+=2; animPop(0); updateUI(); } }, 4000);
    }

    function setTactic(type) {
        currentTactic = type;
        document.querySelectorAll('.tactic-card').forEach(el => el.classList.remove('active'));
        document.getElementById('tac-'+type).classList.add('active');
        const badge = document.getElementById('ui-tactic-badge');
        badge.innerText = type === 'normal' ? 'NORMAL' : (type === 'attack' ? 'TAARRUZ' : (type === 'defense' ? 'TAHKƒ∞MAT' : 'LOJƒ∞STƒ∞K'));
        if(type === 'attack') badge.style.color = '#e74c3c';
        else if(type === 'defense') badge.style.color = '#3498db';
        else if(type === 'speed') badge.style.color = '#2ecc71';
        else badge.style.color = '#fff';
        let cost = 5; if(currentTactic === 'speed') cost = 4;
        document.getElementById('ui-recruit-cost').innerText = cost;
        missionUpdate('tactic', 1);
        updateUI();
    }

    function attemptMove(from, to) {
        if(isPaused) return;
        const r1 = Math.floor(from/GRID_W), c1 = from%GRID_W;
        const r2 = Math.floor(to/GRID_W), c2 = to%GRID_W;
        if(Math.abs(r1-r2) + Math.abs(c1-c2) !== 1) return;

        const src = tiles[from];
        const dest = tiles[to];
        if(src.army <= 1) return;

        let force = Math.floor(src.army / 2);
        src.army -= force;

        let attackPower = force;
        if(currentTactic === 'attack') attackPower = Math.floor(force * 1.5); 
        if(currentTactic === 'defense') attackPower = Math.floor(force * 0.7); 
        if(currentTactic === 'speed') attackPower = Math.floor(force * 0.8); 

        if(dest.owner === 1) {
            dest.army += force; 
        } else {
            if(dest.owner === 0 && dest.hiddenBarb > 0) {
                playSound('ambush');
                dest.army += dest.hiddenBarb; dest.hiddenBarb = 0; dest.owner = 3; dest.el.classList.add('barbarian');
                showFloatText("‚ö†Ô∏è PUSU!", dest.el, 'bad');
                if(attackPower > dest.army) {
                    dest.army = attackPower - dest.army; dest.owner = 1; dest.el.classList.remove('barbarian');
                    missionUpdate('kill', 5); handleVictory(dest.army);
                } else { dest.army -= attackPower; handleDefeat(); }
            } else {
                let enemyDefense = dest.army;
                if(attackPower > enemyDefense) {
                    missionUpdate('kill', enemyDefense);
                    dest.army = attackPower - enemyDefense; dest.owner = 1; dest.trap = 0; dest.hiddenBarb = 0;
                    playSound('fight'); missionUpdate('conquer', 1); handleVictory(enemyDefense); checkWin();
                } else {
                    missionUpdate('kill', attackPower); dest.army -= attackPower; playSound('fight'); handleDefeat();
                }
            }
        }
        updateUI();
    }

    function handleVictory(enemySize) {
        let boost = 5 + Math.floor(enemySize / 2); if(boost > 40) boost = 40;
        taxEfficiency += boost; if(taxEfficiency > 100) taxEfficiency = 100;
        let color = boost > 15 ? 'green' : 'white';
        showFloatText(`Destek +%${boost}`, document.body, color); playSound('good');
    }

    function handleDefeat() {
        taxEfficiency -= 10; if(taxEfficiency < 10) taxEfficiency = 10;
        showFloatText("Destek D√º≈üt√º!", document.body, 'bad');
    }

    function collectTax() {
        if(!taxReady || isPaused) return;
        const playerTiles = tiles.filter(t => t.owner === 1);
        let baseIncome = playerTiles.reduce((sum, t) => sum + t.economy, 0) + incomeBonus + 5;
        let finalIncome = Math.floor(baseIncome * (taxEfficiency / 100));
        
        gold += finalIncome; missionUpdate('tax', finalIncome); playSound('coin'); showFloatText(`+${finalIncome}g`, document.getElementById('btn-tax'));
        
        let decay = 10; if(finalIncome > 50) decay = 15; if(finalIncome > 100) decay = 20;
        taxEfficiency -= decay; if(taxEfficiency < 10) taxEfficiency = 10;
        
        taxReady = false; document.getElementById('btn-tax').disabled = true;
        let w=0; let int = setInterval(()=>{ if(!isPaused) { w+=5; document.getElementById('tax-cd').style.width=w/20+"%"; if(w>=2000){clearInterval(int); taxReady=true; document.getElementById('btn-tax').disabled=false;} } }, 10);
        updateUI();
    }

    function checkDailyMissions() {
        const today = new Date().toDateString();
        if(lastMissionDate !== today) { generateDailyMissions(); lastMissionDate = today; saveData(); document.getElementById('quest-alert').style.display = 'block'; }
    }
    function generateDailyMissions() {
        dailyMissions = [];
        const pool = [ { id: 'kill', txt: "D√º≈üman Askeri Yok Et", base: 10, rew: 20 }, { id: 'conquer', txt: "B√∂lge Fethet", base: 3, rew: 30 }, { id: 'spend', txt: "Altƒ±n Harca", base: 50, rew: 25 }, { id: 'recruit', txt: "Asker Topla", base: 20, rew: 15 }, { id: 'tax', txt: "Vergi Topla (Miktar)", base: 100, rew: 40 }, { id: 'trap', txt: "Pusu Kur", base: 2, rew: 35 }, { id: 'tactic', txt: "Taktik Deƒüi≈ütir", base: 3, rew: 10 } ];
        for(let i=0; i<6; i++) {
            const m = pool[Math.floor(Math.random() * pool.length)];
            let target = Math.floor(m.base * (1 + (level * 0.2)));
            dailyMissions.push({ id: m.id, desc: m.txt, target: target, current: 0, reward: m.rew, done: false });
        }
    }
    function missionUpdate(type, amt) {
        let updated = false;
        dailyMissions.forEach(m => {
            if(!m.done && m.id === type) { m.current += amt; if(m.current >= m.target) { m.current = m.target; m.done = true; gold += m.reward; showFloatText(`G√ñREV: +${m.reward}g`, document.body, 'green'); playSound('good'); updated = true; } }
        });
        if(updated) saveData();
    }
    function openMissions() {
        document.getElementById('quest-alert').style.display = 'none';
        let html = '';
        dailyMissions.forEach(m => {
            let pct = (m.current / m.target) * 100;
            let color = m.done ? '#2ecc71' : '#f1c40f';
            html += `<div class="list-item"><div style="width:100%"><div style="display:flex; justify-content:space-between; font-size:12px;"><span>${m.desc}</span><span style="color:${color}">${m.done ? 'TAMAMLANDI' : '+' + m.reward + 'g'}</span></div><div class="prog-bar"><div class="prog-fill" style="width:${pct}%; background:${color}"></div></div><div style="font-size:10px; text-align:right; color:#aaa;">${m.current}/${m.target}</div></div></div>`;
        });
        document.getElementById('mission-list').innerHTML = html; openModal('missions-modal');
    }

    function aiLoop() {
        if(isPaused) return;
        const units = tiles.filter(t => t.owner === 2);
        units.forEach(t => {
            if(Math.random() > 0.3 && t.army > 2) {
                const adj = [t.id-1, t.id+1, t.id-GRID_W, t.id+GRID_W].filter(n => n>=0 && n<TOTAL);
                const targetId = adj.find(n => tiles[n] && (Math.abs((t.id%GRID_W)-(n%GRID_W))+Math.abs(Math.floor(t.id/GRID_W)-Math.floor(n/GRID_W))===1));
                if(targetId !== undefined) {
                    const target = tiles[targetId];
                    if(target.owner !== 2) {
                        const force = Math.floor(t.army/2); t.army -= force;
                        if(target.owner === 0 && target.trap > 0) {
                            if(target.trap > force) { target.owner = 1; target.army = target.trap - force; target.trap = 0; showFloatText("Pusu Tuttu!", target.el); } 
                            else { target.owner = 2; target.army = force - target.trap; target.trap = 0; }
                        } else {
                            let effectiveForce = force;
                            if(target.owner === 1 && currentTactic === 'defense') effectiveForce = Math.floor(force * 0.7);
                            if(effectiveForce > target.army) { target.army = effectiveForce - target.army; target.owner = 2; checkWin(); } else { target.army -= effectiveForce; }
                        }
                    }
                }
            } else { t.army += 1 + Math.floor(level/5); }
        });
        updateUI();
    }

    function recruitAction() {
        if(isPaused) return;
        if(selectedIdx===null || tiles[selectedIdx].owner!==1) return;
        let cost = 5; if(currentTactic === 'speed') cost = 4;
        if(gold < cost) return;
        gold -= cost; missionUpdate('spend', cost); missionUpdate('recruit', 5);
        tiles[selectedIdx].army += 5; animPop(selectedIdx); updateUI();
    }
    
    function setTrap() {
        if(isPaused) return;
        if(selectedIdx === null || tiles[selectedIdx].owner !== 0) return alert("Tarafsƒ±z b√∂lge se√ß!");
        if(gold < 15) return;
        gold-=15; missionUpdate('spend', 15); missionUpdate('trap', 1);
        tiles[selectedIdx].trap += 5; showFloatText("ü™§ Gizlendi", tiles[selectedIdx].el); updateUI();
    }

    function buyItem(type) {
        if(type==='income' && gold>=50) { gold-=50; incomeBonus+=3; missionUpdate('spend', 50); }
        else if(type==='merc' && gold>=40) { if(selectedIdx!==null && tiles[selectedIdx].owner===1){gold-=40; tiles[selectedIdx].army+=15; missionUpdate('spend', 40);} }
        else if(type==='nuke' && gold>=120) { gold-=120; tiles.forEach(t=>{if(t.owner===2)t.army=1}); playSound('fight'); missionUpdate('spend', 120); }
        else if(type==='fort' && gold>=60) { if(tiles[0].owner===1) { gold-=60; tiles[0].army+=25; missionUpdate('spend', 60); } }
        else if(type==='spy' && gold>=75) { gold-=75; tiles.forEach(t => { if(t.hiddenBarb > 0) { t.el.classList.add('revealed'); setTimeout(()=>t.el.classList.remove('revealed'), 3000); } }); showFloatText("üëÅÔ∏è Pusular G√∂r√ºnd√º", document.body); missionUpdate('spend', 75); }
        closeModal('shop-modal'); updateUI();
    }

    function updateUI() {
        document.getElementById('ui-gold').innerText = gold;
        const playerTiles = tiles.filter(t => t.owner === 1);
        let baseIncome = playerTiles.reduce((sum, t) => sum + t.economy, 0) + incomeBonus + 5;
        let predictedIncome = Math.floor(baseIncome * (taxEfficiency / 100));
        
        document.getElementById('ui-income').innerText = predictedIncome;
        document.getElementById('ui-efficiency').innerText = taxEfficiency;
        
        let effEl = document.getElementById('ui-efficiency');
        if(taxEfficiency > 70) effEl.style.color = "#2ecc71"; else if(taxEfficiency > 30) effEl.style.color = "#f1c40f"; else effEl.style.color = "#e74c3c";

        tiles.forEach(t => {
            const el = t.el; el.className = 'tile';
            if(t.owner===1) el.classList.add('player'); else if(t.owner===2) el.classList.add('enemy'); else if(t.owner===3) el.classList.add('barbarian'); else el.classList.add('neutral');
            const trap = el.querySelector('.trap-indicator'); trap.style.display = (t.trap > 0 && t.owner===0) ? 'block' : 'none';
            if(selectedIdx===t.id) el.style.border="2px solid white"; else el.style.border="";
            el.querySelector('span').innerText = t.army;
        });
        saveData();
    }
    
    function saveData() {
        const colors = { player: getComputedStyle(document.documentElement).getPropertyValue('--player').trim(), enemy: getComputedStyle(document.documentElement).getPropertyValue('--enemy').trim(), barb: getComputedStyle(document.documentElement).getPropertyValue('--barb').trim() };
        localStorage.setItem('aos_pro_save', JSON.stringify({level, gold, income:incomeBonus, missions: dailyMissions, date: lastMissionDate, colors}));
    }

    function checkWin() { if(tiles.filter(t=>t.owner===1).length===0) { alert("YENƒ∞LDƒ∞N"); init(false); } else if(tiles.filter(t=>t.owner===2).length===0) { alert("ZAFER!"); level++; init(true); } }

    function setSkin(who, color) { document.documentElement.style.setProperty('--' + who, color); saveData(); }
    function togglePause(){ isPaused=!isPaused; document.getElementById('pause-overlay').style.display=isPaused?'flex':'none'; }
    function openModal(id){ document.getElementById(id).style.display='flex'; isPaused=true; }
    function closeModal(id){ document.getElementById(id).style.display='none'; isPaused=false; }
    function openSettings(){ openModal('settings-modal'); }
    function fullReset(){ localStorage.removeItem('aos_pro_save'); location.reload(); }
    function submitCode(){ const val = document.getElementById('cheat-code').value.trim().toUpperCase(); if(val==='PARA'){ gold+=500; updateUI(); closeModal('settings-modal'); } else if(val==='LEVEL'){ level++; init(true); closeModal('settings-modal'); } else {alert("Kod Hatalƒ±");} }
    function showFloatText(txt,t,c){ if(!t)return; const r=t.getBoundingClientRect?t.getBoundingClientRect():{top:100,left:100}; const e=document.createElement('div'); e.className='float-text '+(c||''); e.innerText=txt; e.style.left=r.left+'px'; e.style.top=r.top+'px'; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
    function animPop(i){ tiles[i].el.classList.remove('anim-pop'); void tiles[i].el.offsetWidth; tiles[i].el.classList.add('anim-pop'); }

    function startDrag(e){if(isPaused)return; if(e.target.closest('.tile')){e.preventDefault();const i=parseInt(e.target.closest('.tile').dataset.idx); if(tiles[i].owner===1||tiles[i].owner===0){selectedIdx=i;updateUI();} if(tiles[i].owner===1){isDragging=true;dragStartIdx=i;}}}
    function doDrag(e){if(!isDragging||isPaused)return;e.preventDefault();const t=e.touches?e.touches[0]:e;const b=tiles[dragStartIdx].el.getBoundingClientRect();drawArrow(b.left+b.width/2,b.top+b.height/2,t.clientX,t.clientY);}
    function endDrag(e){if(!isDragging)return;isDragging=false;document.getElementById('drag-line').style.display='none';document.getElementById('drag-head').style.display='none';const t=e.changedTouches?e.changedTouches[0]:e;const el=document.elementFromPoint(t.clientX,t.clientY);if(el&&el.closest('.tile')){const i=parseInt(el.closest('.tile').dataset.idx);if(i!==dragStartIdx)attemptMove(dragStartIdx,i);}}
    function drawArrow(x1,y1,x2,y2){const l=document.getElementById('drag-line'),h=document.getElementById('drag-head');l.style.display='block';l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);const a=Math.atan2(y2-y1,x2-x1);h.style.display='block';h.setAttribute('points',`${x2},${y2} ${x2-20*Math.cos(a-0.5)},${y2-20*Math.sin(a-0.5)} ${x2-20*Math.cos(a+0.5)},${y2-20*Math.sin(a+0.5)}`);}

    init();
</script>
</body>
</html>
