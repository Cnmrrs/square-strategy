<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Square Strategy: NPM Accounts</title>
    <style>
        * { box-sizing: border-box; }

        :root {
            --bg: #121212;
            --panel: #1e272e;
            --player: #3498db;
            --enemy: #c0392b;
            --barb: #d35400;
            --gold: #f1c40f;
            --text: #ecf0f1;
            --green: #2ecc71;
            --npm: #cb3837;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            align-items: center;
            justify-content: center;
        }

        #app-frame {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            height: 100%;
            max-height: 100vh;
            position: relative;
            background: #000;
        }

        #header {
            background: var(--panel);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-size: 13px;
            z-index: 100;
            width: 100%;
        }
        .header-left, .header-right { display: flex; gap: 5px; align-items: center; }
        
        .badge { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 11px;}
        .gold-txt { color: var(--gold); }
        .tactic-badge { border: 1px solid #777; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .icon-btn {
            background: #444; border: none; color: white; border-radius: 5px;
            width: 32px; height: 32px; cursor: pointer; font-size: 16px; 
            display:flex; justify-content:center; align-items:center;
            transition: 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        .btn-user { background: var(--npm); box-shadow: 0 0 5px var(--npm); position: relative; }
        .user-status { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; border: 1px solid #fff; display: none; }
        .btn-help { background: #2980b9; }
        .btn-quest { background: #8e44ad; position: relative; }
        .quest-alert { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: red; border-radius: 50%; display: none; }
        .btn-skin { background: #16a085; }

        #game-container {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            width: 96%;
            aspect-ratio: 1/1;
            position: relative;
            z-index: 10;
            margin: 0 auto;
        }

        .tile {
            background: #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.6);
            position: relative;
            transition: transform 0.1s, background 0.2s;
        }
        
        .tile.player { background: var(--player); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.enemy { background: var(--enemy); border-bottom: 3px solid rgba(0,0,0,0.3); }
        .tile.barbarian { background: var(--barb); border-bottom: 3px solid rgba(0,0,0,0.3); animation: shake 0.5s; }
        .tile.neutral { background: #555; opacity: 0.7; }
        .tile.revealed { border: 2px solid var(--barb); }
        
        .trap-indicator { position: absolute; bottom: 2px; right: 2px; width: 6px; height: 6px; background: cyan; border-radius: 50%; box-shadow: 0 0 4px white; display: none; }
        .base-indicator { position: absolute; top: -8px; right: -5px; font-size: 16px; z-index: 20; text-shadow: 0 0 4px black; display: none; filter: drop-shadow(0 0 2px gold); }
        .tile span { pointer-events: none; z-index: 12; text-shadow: 1px 1px 3px black; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }

        #footer { background: var(--panel); padding: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 101; width: 100%; }
        .btn-row { display: flex; gap: 5px; }
        button.action-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); font-size:12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        button.action-btn:active { transform: translateY(2px); box-shadow: none; }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-green { background: #27ae60; }
        .btn-orange { background: #e67e22; }
        .btn-purp { background: #8e44ad; }
        .btn-red { background: #c0392b; } 
        .btn-trap { background: #34495e; border: 1px solid #3498db; }
        .btn-base { background: #f39c12; color: #222; } 
        
        .cd-overlay { position: absolute; bottom: 0; left: 0; height: 4px; width: 0%; background: rgba(255,255,255,0.7); transition: width 0.1s linear; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #444; max-height: 85vh; overflow-y: auto; }
        
        .list-item { background: #333; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .prog-bar { width: 100%; height: 6px; background: #555; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }

        .tactic-card { border: 2px solid #444; padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; }
        .tactic-card.active { border-color: var(--gold); background: rgba(241, 196, 15, 0.1); }
        .tactic-title { font-weight: bold; margin-bottom: 2px; }
        .tactic-desc { font-size: 11px; color: #aaa; }

        .color-opt { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; display: inline-block; margin: 5px;}

        /* Login Inputs */
        .auth-input { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #555; background: #333; color: white; }
        .auth-link { color: var(--gold); cursor: pointer; text-decoration: underline; font-size: 12px; }
        .error-msg { color: #e74c3c; font-size: 12px; margin-bottom: 10px; display: none; }

        #achieve-notify { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid var(--gold); padding: 15px; border-radius: 8px; display: none; z-index: 3000; text-align: center; animation: slideDown 0.5s; width: 80%; max-width: 300px; }
        #achieve-notify h4 { margin: 0 0 5px 0; color: var(--gold); }
        #achieve-notify p { margin: 0; font-size: 12px; color: #fff; }

        @keyframes slideDown { 0% {top: -50px; opacity: 0;} 100% {top: 60px; opacity: 1;} }
        @keyframes pop { 50% { transform: scale(1.4); filter: brightness(1.5); } }
        .anim-pop { animation: pop 0.2s ease-out; z-index: 15 !important; }

        .float-text { position: absolute; color: var(--gold); font-weight: bold; font-size: 18px; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 20; text-shadow: 0 0 3px black; }
        .float-text.bad { color: var(--barb); font-size: 22px; z-index: 25; }
        .float-text.green { color: var(--green); font-size: 20px; z-index: 25; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-50px); opacity:0; } }

        #pause-overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1500; flex-direction:column; justify-content:center; align-items:center; color:white; backdrop-filter: blur(3px); }
        
        .achieve-row { opacity: 0.5; padding: 10px; border-bottom: 1px solid #444; text-align: left; }
        .achieve-row.unlocked { opacity: 1; border-left: 4px solid var(--gold); background: rgba(241, 196, 15, 0.1); }
        .achieve-title { font-weight: bold; color: var(--gold); }

    </style>
</head>
<body>

    <div id="achieve-notify">
        <h4>üèÜ BA≈ûARIM A√áILDI!</h4>
        <p id="achieve-text">Mesaj</p>
    </div>

    <div id="app-frame">
        <div id="header">
            <div class="header-left">
                <button class="icon-btn btn-user" onclick="openProfile()">üë§<div id="status-dot" class="user-status"></div></button>
                <button class="icon-btn btn-quest" onclick="openMissions()">üìú<div class="quest-alert" id="quest-alert"></div></button>
                <button class="icon-btn btn-skin" onclick="openModal('skin-modal')">üé®</button>
                <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
            <div class="header-right">
                <span class="badge tactic-badge" id="ui-tactic-badge">NORMAL</span>
                <span class="badge">üí∞ <span id="ui-gold" class="gold-txt">0</span></span>
                <button class="icon-btn" onclick="togglePause()">‚è∏</button>
            </div>
        </div>

        <div id="game-container">
            <div id="map-grid"></div>
            <div id="pause-overlay">
                <h3>OYUN DURAKLATILDI</h3>
                <button class="action-btn btn-green" style="width:120px; flex:none;" onclick="togglePause()">DEVAM ET</button>
            </div>
            <svg id="arrow-layer">
                <line id="drag-line" x1="0" y1="0" x2="0" y2="0" stroke="#f1c40f" stroke-width="12" stroke-linecap="round" style="display:none; opacity: 0.9;" />
                <polygon id="drag-head" points="0,0" fill="#f1c40f" style="display:none;" />
            </svg>
        </div>

        <div id="footer">
            <div class="btn-row">
                <button class="action-btn btn-red" onclick="openModal('tactic-modal')">‚öîÔ∏è TAKTƒ∞K</button>
                <button class="action-btn btn-trap" onclick="setTrap()">ü™§ PUSU (15g)</button>
                <button class="action-btn btn-orange" onclick="openModal('shop-modal')">üõí MAƒûAZA</button>
            </div>
            <div class="btn-row">
                <button id="btn-recruit" class="action-btn btn-green" onclick="recruitAction()">+ ASKER (<span id="ui-recruit-cost">5</span>g)</button>
                <button class="action-btn btn-base" onclick="moveBase()">üè∞ √úS TA≈ûI (50g)</button>
                <button id="btn-tax" class="action-btn btn-purp" onclick="collectTax()">
                    <span>VERGƒ∞: +<span id="ui-income">0</span>g</span>
                    <span style="font-size:9px; color:#ddd;">Halk: %<span id="ui-efficiency">100</span></span>
                    <div class="cd-overlay" id="tax-cd"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--npm);">NPM LAUNCHER HESABI</h3>
            
            <div id="auth-login">
                <p>Mevcut hesabƒ±nla giri≈ü yap</p>
                <div id="login-error" class="error-msg"></div>
                <input type="text" id="login-user" class="auth-input" placeholder="Kullanƒ±cƒ± Adƒ±">
                <input type="password" id="login-pass" class="auth-input" placeholder="≈ûifre">
                <button class="action-btn btn-green" onclick="authLogin()">Gƒ∞Rƒ∞≈û YAP</button>
                <br>
                <span class="auth-link" onclick="switchAuth('register')">Hesabƒ±n yok mu? Kayƒ±t Ol</span>
            </div>

            <div id="auth-register" style="display:none;">
                <p>Yeni hesap olu≈ütur (+500 Altƒ±n Bonus)</p>
                <div id="reg-error" class="error-msg"></div>
                <input type="text" id="reg-user" class="auth-input" placeholder="Yeni Kullanƒ±cƒ± Adƒ±">
                <input type="password" id="reg-pass" class="auth-input" placeholder="≈ûifre">
                <button class="action-btn btn-orange" onclick="authRegister()">KAYIT OL</button>
                <br>
                <span class="auth-link" onclick="switchAuth('login')">Zaten hesabƒ±n var mƒ±? Giri≈ü Yap</span>
            </div>

            <div id="auth-profile" style="display:none;">
                <h4 id="user-display" style="color:#fff;">Kullanƒ±cƒ±</h4>
                <div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <div style="font-size:12px; color:#aaa;">NPM PUANI</div>
                    <div style="font-size:24px; font-weight:bold; color:var(--green);" id="user-score">0</div>
                </div>
                <hr style="border-color:#444;">
                <h4 style="margin:10px 0;">BA≈ûARIMLAR</h4>
                <div id="achieve-list" style="max-height:150px; overflow-y:auto;"></div>
                <br>
                <button class="action-btn btn-red" onclick="authLogout()">√áIKI≈û YAP</button>
            </div>
            <br>
            <button class="action-btn" onclick="closeModal('profile-modal')">KAPAT</button>
        </div>
    </div>

    <div id="missions-modal" class="modal"><div class="modal-content"><h3 style="color:#8e44ad;">G√úNL√úK G√ñREVLER</h3><p style="font-size:11px; color:#aaa;" id="mission-timer">Yenilenme: Yarƒ±n</p><div id="mission-list"></div><br><button class="action-btn btn-green" onclick="closeModal('missions-modal')">KAPAT</button></div></div>
    <div id="tactic-modal" class="modal"><div class="modal-content"><h3 style="color:#c0392b;">SAVA≈û DOKTRƒ∞Nƒ∞</h3><div class="tactic-card" id="tac-normal" onclick="setTactic('normal')"><div class="tactic-title">‚ö™ NORMAL</div><div class="tactic-desc">Dengeli. Bonus veya ceza yok.</div></div><div class="tactic-card" id="tac-attack" onclick="setTactic('attack')"><div class="tactic-title">üî¥ TAARRUZ (H√ºcum)</div><div class="tactic-desc">Saldƒ±rƒ± G√ºc√º: <strong>+%50</strong><br>Savunma Zafiyeti: <strong>Alƒ±nan hasar artar.</strong></div></div><div class="tactic-card" id="tac-defense" onclick="setTactic('defense')"><div class="tactic-title">üîµ TAHKƒ∞MAT (Savunma)</div><div class="tactic-desc">Savunma G√ºc√º: <strong>+%50</strong><br>Saldƒ±rƒ± Cezasƒ±: <strong>-%30 Hasar.</strong></div></div><div class="tactic-card" id="tac-speed" onclick="setTactic('speed')"><div class="tactic-title">üü¢ LOJƒ∞STƒ∞K (Ekonomi)</div><div class="tactic-desc">Asker Maliyeti: <strong>4g</strong> (Ucuz)<br>Sava≈ü G√ºc√º: <strong>-%20 Hasar.</strong></div></div><br><button class="action-btn btn-green" onclick="closeModal('tactic-modal')">ONAYLA</button></div></div>
    <div id="help-modal" class="modal"><div class="modal-content"><h3 style="color:#3498db;">YENƒ∞ KURALLAR</h3><div style="text-align:left;font-size:13px;"><p>üè∞ <strong>ANA √úS:</strong> Kalen d√º≈üerse kaybedersin.</p><p>üë§ <strong>Hesap:</strong> Kayƒ±t olursan verilerin buluta (local) kaydedilir.</p><p>üìä <strong>Ekonomi:</strong> Vergi halkƒ± yorar, fetih sevindirir.</p></div><button class="action-btn btn-green" onclick="closeModal('help-modal')">ANLADIM</button></div></div>
    <div id="skin-modal" class="modal"><div class="modal-content"><h3>√ñZELLE≈ûTƒ∞RME</h3><p>Sen:</p><div><span class="color-opt" style="background:#3498db" onclick="setSkin('player', '#3498db')"></span><span class="color-opt" style="background:#1abc9c" onclick="setSkin('player', '#1abc9c')"></span><span class="color-opt" style="background:#9b59b6" onclick="setSkin('player', '#9b59b6')"></span></div><p>D√º≈üman:</p><div><span class="color-opt" style="background:#c0392b" onclick="setSkin('enemy', '#c0392b')"></span><span class="color-opt" style="background:#e67e22" onclick="setSkin('enemy', '#e67e22')"></span></div><p>Barbar:</p><div><span class="color-opt" style="background:#d35400" onclick="setSkin('barb', '#d35400')"></span><span class="color-opt" style="background:#8e44ad" onclick="setSkin('barb', '#8e44ad')"></span></div><br><button class="action-btn btn-green" onclick="closeModal('skin-modal')">KAYDET</button></div></div>
    <div id="shop-modal" class="modal"><div class="modal-content"><h3 style="color:#e67e22;">MAƒûAZA</h3><div class="list-item" onclick="buyItem('income')"><div>üìà <strong>Yatƒ±rƒ±m</strong><br><small>Gelir +3</small></div><div style="color:var(--gold)">50g</div></div><div class="list-item" onclick="buyItem('merc')"><div>‚öîÔ∏è <strong>Paralƒ± Asker</strong><br><small>+15 Asker</small></div><div style="color:var(--gold)">40g</div></div><div class="list-item" onclick="buyItem('fort')"><div>üè∞ <strong>Kale</strong><br><small>Merkez +25 Asker</small></div><div style="color:var(--gold)">60g</div></div><div class="list-item" onclick="buyItem('spy')"><div>üëÅÔ∏è <strong>Casus</strong><br><small>Pusularƒ± G√∂r</small></div><div style="color:var(--gold)">75g</div></div><div class="list-item" onclick="buyItem('nuke')"><div>üí£ <strong>Hava Saldƒ±rƒ±sƒ±</strong><br><small>D√º≈ümanƒ± Vur</small></div><div style="color:var(--gold)">120g</div></div><br><button class="action-btn btn-blue" onclick="closeModal('shop-modal')">√áIKI≈û</button></div></div>
    <div id="settings-modal" class="modal"><div class="modal-content"><h3>AYARLAR</h3><div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;"><input type="text" id="cheat-code" style="width:70%; padding:8px; text-transform:uppercase;" placeholder="KOD"><button class="action-btn btn-purp" style="padding:8px; width:auto;" onclick="submitCode()">OK</button></div><button class="action-btn" style="background:#c0392b;" onclick="fullReset()">‚ö†Ô∏è SIFIRLA</button><br><br><button class="action-btn btn-green" onclick="closeModal('settings-modal')">KAPAT</button></div></div>

<script>
    const GRID_W = 8;
    const TOTAL = GRID_W * GRID_W;
    
    // Global Deƒüi≈ükenler
    let gold = 0, level = 1, incomeBonus = 0, tiles = [], isPaused = false;
    let dragStartIdx = null, isDragging = false, selectedIdx = null;
    let taxReady = true, taxEfficiency = 100, currentTactic = 'normal';
    let dailyMissions = [], lastMissionDate = "", baseIdx = 0;
    
    // Auth & Database
    let currentUser = null; // ≈ûu an giri≈ü yapmƒ±≈ü kullanƒ±cƒ± nesnesi
    const achievements = [
        { id: 'first_win', title: 'ƒ∞lk Zafer', desc: 'Bir b√∂l√ºm√º kazan', xp: 100, reward: 50 },
        { id: 'rich', title: 'Zengin', desc: '1000 Altƒ±na ula≈ü', xp: 500, reward: 200 },
        { id: 'ambush_king', title: 'Pusu Ustasƒ±', desc: '5 Pusu kur', xp: 300, reward: 100 },
        { id: 'survivor', title: 'Hayatta Kalan', desc: 'Seviye 5 e ula≈ü', xp: 1000, reward: 500 }
    ];

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext();

    function playSound(type) {
        if(isPaused) return; if(audioCtx.state==='suspended') audioCtx.resume();
        const osc=audioCtx.createOscillator(), gain=audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const now=audioCtx.currentTime;
        if(type==='coin'){osc.frequency.setValueAtTime(1200,now);gain.gain.setValueAtTime(0.05,now);osc.frequency.linearRampToValueAtTime(1800,now+0.1);gain.gain.linearRampToValueAtTime(0,now+0.1);osc.start(now);osc.stop(now+0.1);}
        else if(type==='fight'){osc.type='sawtooth';osc.frequency.setValueAtTime(100,now);gain.gain.setValueAtTime(0.1,now);gain.gain.exponentialRampToValueAtTime(0.01,now+0.2);osc.start(now);osc.stop(now+0.2);}
        else if(type==='good'){osc.type='sine';osc.frequency.setValueAtTime(400,now);gain.gain.setValueAtTime(0.1,now);osc.frequency.exponentialRampToValueAtTime(800,now+0.3);gain.gain.linearRampToValueAtTime(0,now+0.3);osc.start(now);osc.stop(now+0.3);}
        else if(type==='achievement'){osc.type='triangle';osc.frequency.setValueAtTime(300,now);osc.frequency.linearRampToValueAtTime(600,now+0.2);osc.frequency.linearRampToValueAtTime(900,now+0.4);gain.gain.setValueAtTime(0.1,now);gain.gain.linearRampToValueAtTime(0,now+0.5);osc.start(now);osc.stop(now+0.5);}
    }

    // --- AUTHENTICATION (KAYIT/Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞) ---
    function getDB() { return JSON.parse(localStorage.getItem('aos_users_db')) || []; }
    function saveDB(db) { localStorage.setItem('aos_users_db', JSON.stringify(db)); }

    function switchAuth(mode) {
        document.getElementById('login-error').style.display='none';
        document.getElementById('reg-error').style.display='none';
        if(mode === 'login') {
            document.getElementById('auth-login').style.display = 'block';
            document.getElementById('auth-register').style.display = 'none';
        } else {
            document.getElementById('auth-login').style.display = 'none';
            document.getElementById('auth-register').style.display = 'block';
        }
    }

    function authRegister() {
        const u = document.getElementById('reg-user').value.trim();
        const p = document.getElementById('reg-pass').value.trim();
        const err = document.getElementById('reg-error');
        
        if(u.length < 3 || p.length < 3) { err.innerText = "En az 3 karakter gerekli!"; err.style.display='block'; return; }
        
        let db = getDB();
        if(db.find(x => x.username === u)) { err.innerText = "Bu kullanƒ±cƒ± adƒ± dolu!"; err.style.display='block'; return; }

        // Yeni Kullanƒ±cƒ± Olu≈ütur
        const newUser = { username: u, password: p, score: 0, unlocked: [], gameData: null };
        db.push(newUser);
        saveDB(db);

        // Otomatik Giri≈ü ve Bonus
        currentUser = newUser;
        gold = 500; // KAYIT BONUSU
        alert("Kayƒ±t Ba≈üarƒ±lƒ±! +500 Altƒ±n Ho≈ügeldin Bonusu Eklendi.");
        
        init(false); // Oyunu ba≈ülat/sƒ±fƒ±rla
        updateProfileUI();
    }

    function authLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        const err = document.getElementById('login-error');

        let db = getDB();
        const user = db.find(x => x.username === u && x.password === p);

        if(!user) { err.innerText = "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!"; err.style.display='block'; return; }

        currentUser = user;
        alert(`Giri≈ü Yapƒ±ldƒ±: ${u}`);
        
        // Kullanƒ±cƒ±nƒ±n kayƒ±tlƒ± oyununu y√ºkle
        if(user.gameData) loadGameData(user.gameData);
        else init(false); // Kayƒ±t yoksa sƒ±fƒ±rdan ba≈üla

        updateProfileUI();
    }

    function authLogout() {
        if(confirm("√áƒ±kƒ±≈ü yapmak √ºzeresin?")) {
            saveGame(); // √áƒ±kmadan kaydet
            currentUser = null;
            document.getElementById('status-dot').style.display = 'none';
            init(false); // Misafir moduna d√∂n (Sƒ±fƒ±rla)
            switchAuth('login');
            updateProfileUI();
        }
    }

    function openProfile() { 
        document.getElementById('profile-modal').style.display = 'flex'; 
        isPaused = true; 
        updateProfileUI(); 
    }

    function updateProfileUI() {
        if(currentUser) {
            document.getElementById('auth-login').style.display = 'none';
            document.getElementById('auth-register').style.display = 'none';
            document.getElementById('auth-profile').style.display = 'block';
            document.getElementById('status-dot').style.display = 'block';
            document.getElementById('user-display').innerText = currentUser.username;
            document.getElementById('user-score').innerText = currentUser.score + " XP";
            
            let html = '';
            achievements.forEach(a => {
                const isUnlocked = currentUser.unlocked.includes(a.id);
                html += `<div class="achieve-row ${isUnlocked ? 'unlocked' : ''}">
                    <div class="achieve-title">${a.title} ${isUnlocked ? '‚úÖ' : 'üîí'}</div>
                    <small>${a.desc}</small>
                </div>`;
            });
            document.getElementById('achieve-list').innerHTML = html;
        } else {
            document.getElementById('auth-profile').style.display = 'none';
            switchAuth('login'); // Varsayƒ±lan login ekranƒ±
        }
    }

    function saveGame() {
        const data = { level, gold, income:incomeBonus, missions: dailyMissions, date: lastMissionDate, 
            colors: { player: getComputedStyle(document.documentElement).getPropertyValue('--player').trim(), enemy: getComputedStyle(document.documentElement).getPropertyValue('--enemy').trim(), barb: getComputedStyle(document.documentElement).getPropertyValue('--barb').trim() }
        };

        if(currentUser) {
            // Kullanƒ±cƒ± veritabanƒ±na kaydet
            let db = getDB();
            let userIdx = db.findIndex(u => u.username === currentUser.username);
            if(userIdx !== -1) {
                db[userIdx].gameData = data;
                db[userIdx].score = currentUser.score;
                db[userIdx].unlocked = currentUser.unlocked;
                saveDB(db);
            }
        } else {
            // Misafir kaydƒ±
            localStorage.setItem('aos_guest_save', JSON.stringify(data));
        }
    }

    function loadGameData(d) {
        level = d.level || 1; gold = d.gold || 0; incomeBonus = d.income || 0;
        if(d.date) lastMissionDate = d.date;
        if(d.missions) dailyMissions = d.missions;
        if(d.colors) {
            document.documentElement.style.setProperty('--player', d.colors.player);
            document.documentElement.style.setProperty('--enemy', d.colors.enemy);
            if(d.colors.barb) document.documentElement.style.setProperty('--barb', d.colors.barb);
        }
        // Haritayƒ± yeniden √ßiz
        init(true); 
    }

    // --- OYUN CORE ---
    function init(resetMap = false) {
        // Eƒüer resetMap true ise sadece haritayƒ± √ßiz, verileri elleme. 
        // False ise (sayfa yenileme) verileri y√ºklemeye √ßalƒ±≈ü.
        
        document.getElementById('map-grid').innerHTML = '';
        tiles = []; isPaused = false; document.getElementById('pause-overlay').style.display = 'none';
        
        if(!resetMap && !currentUser) {
            // Misafir verisi varsa y√ºkle
            const d = JSON.parse(localStorage.getItem('aos_guest_save'));
            if(d) { loadGameData(d); return; } // loadGameData init(true) √ßaƒüƒ±rƒ±r
        }

        checkDailyMissions();
        taxEfficiency = 100;
        baseIdx = 0; 

        for (let i = 0; i < TOTAL; i++) {
            let owner = 0, army = Math.floor(Math.random() * 3) + 1, economy = Math.floor(Math.random() * 3) + 1, hiddenBarb = 0;
            if (i === 0) { owner = 1; army = 15; baseIdx = 0; } 
            else if (i === TOTAL - 1) { owner = 2; army = 20 + (level * 8); } 
            else { if(Math.random() < 0.15) hiddenBarb = 10 + (level * 2); }

            const div = document.createElement('div'); div.className = 'tile neutral'; div.dataset.idx = i;
            div.innerHTML = `<span>${army}</span><div class="trap-indicator"></div><div class="base-indicator">üè∞</div>`;
            div.addEventListener('mousedown', startDrag); div.addEventListener('touchstart', startDrag, {passive: false});
            document.getElementById('map-grid').appendChild(div);
            tiles.push({ id: i, owner, army, economy: economy, trap: 0, hiddenBarb: hiddenBarb, el: div });
        }
        
        window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', endDrag); window.addEventListener('touchmove', doDrag, {passive: false}); window.addEventListener('touchend', endDrag);
        setTactic('normal'); updateUI(); startGameLoops();
    }

    // --- Dƒ∞ƒûER FONKSƒ∞YONLAR (√ñncekilerle Aynƒ±) ---
    function checkAchievement(id) {
        if(!currentUser) return;
        const ach = achievements.find(a => a.id === id);
        if(ach && !currentUser.unlocked.includes(id)) {
            currentUser.unlocked.push(id); currentUser.score += ach.xp; gold += ach.reward;
            const n = document.getElementById('achieve-notify'); document.getElementById('achieve-text').innerText = `${ach.title} (+${ach.reward}g)`; n.style.display = 'block'; playSound('achievement'); setTimeout(() => n.style.display = 'none', 3000);
            saveGame();
        }
    }

    function checkDailyMissions() { const today = new Date().toDateString(); if(lastMissionDate !== today) { generateDailyMissions(); lastMissionDate = today; saveGame(); document.getElementById('quest-alert').style.display = 'block'; } }
    function generateDailyMissions() { dailyMissions = []; const pool = [ { id: 'kill', txt: "D√º≈üman Askeri Yok Et", base: 10, rew: 20 }, { id: 'conquer', txt: "B√∂lge Fethet", base: 3, rew: 30 }, { id: 'spend', txt: "Altƒ±n Harca", base: 50, rew: 25 }, { id: 'recruit', txt: "Asker Topla", base: 20, rew: 15 }, { id: 'tax', txt: "Vergi Topla", base: 100, rew: 40 } ]; for(let i=0; i<5; i++) { const m = pool[Math.floor(Math.random() * pool.length)]; dailyMissions.push({ id: m.id, desc: m.txt, target: Math.floor(m.base * (1 + level*0.2)), current: 0, reward: m.rew, done: false }); } }
    function missionUpdate(type, amt) { let upd=false; dailyMissions.forEach(m => { if(!m.done && m.id === type) { m.current += amt; if(m.current >= m.target) { m.current = m.target; m.done = true; gold += m.reward; showFloatText("G√ñREV TAMAM", document.body, 'green'); playSound('good'); upd=true; } } }); if(upd) saveGame(); }
    
    function recruitAction() { if(isPaused) return; let t = baseIdx; if(tiles[t].owner !== 1) return alert("Ana √úss√ºn√º Kaybettin!"); let cost = currentTactic==='speed'?4:5; if(gold < cost) return; gold -= cost; missionUpdate('spend', cost); missionUpdate('recruit', 5); tiles[t].army += 5; animPop(t); updateUI(); }
    function setTrap() { if(isPaused) return; if(selectedIdx===null||tiles[selectedIdx].owner!==0) return alert("Tarafsƒ±z b√∂lge se√ß!"); if(gold<15)return; gold-=15; tiles[selectedIdx].trap+=5; showFloatText("ü™§ Gizlendi", tiles[selectedIdx].el); missionUpdate('trap', 1); updateUI(); }
    function moveBase() { if(isPaused) return; if(selectedIdx===null||tiles[selectedIdx].owner!==1) return alert("Kendi b√∂lgende bir kare se√ß!"); if(selectedIdx===baseIdx) return alert("Zaten Ana √ús!"); if(gold<50)return alert("50g Gerekli"); gold-=50; baseIdx=selectedIdx; playSound('good'); showFloatText("√úS TA≈ûINDI", tiles[baseIdx].el, 'green'); updateUI(); }
    
    function aiLoop() { if(isPaused) return; const units = tiles.filter(t => t.owner === 2); units.forEach(t => { if(Math.random()>0.3 && t.army>2) { const adj = [t.id-1, t.id+1, t.id-GRID_W, t.id+GRID_W].filter(n=>n>=0 && n<TOTAL); const tid = adj.find(n=>tiles[n] && (Math.abs((t.id%GRID_W)-(n%GRID_W))+Math.abs(Math.floor(t.id/GRID_W)-Math.floor(n/GRID_W))===1)); if(tid!==undefined){ const tar=tiles[tid]; if(tar.owner!==2){ const f=Math.floor(t.army/2); t.army-=f; let win=false; if(tar.owner===0 && tar.trap>0){ if(tar.trap>f){tar.owner=1; tar.army=tar.trap-f; tar.trap=0; showFloatText("Pusu!", tar.el);} else {tar.owner=2; tar.army=f-tar.trap; tar.trap=0; win=true;} } else { let eff=f; if(tar.owner===1 && currentTactic==='defense') eff=Math.floor(f*0.7); if(eff>tar.army){tar.army=eff-tar.army; tar.owner=2; win=true;} else {tar.army-=eff;} } if(win){ if(tar.id===baseIdx){ setTimeout(()=>{alert("KAYBETTƒ∞N!"); init(false);},100); } } } } } else { t.army+=1+Math.floor(level/5); } }); updateUI(); }
    
    function collectTax() { if(!taxReady || isPaused) return; const inc = tiles.filter(t=>t.owner===1).reduce((s,t)=>s+t.economy,0)+incomeBonus+5; const fi = Math.floor(inc*(taxEfficiency/100)); gold+=fi; missionUpdate('tax', fi); playSound('coin'); showFloatText(`+${fi}g`, document.getElementById('btn-tax')); if(gold>=1000) checkAchievement('rich'); taxEfficiency = Math.max(10, taxEfficiency-10); taxReady=false; document.getElementById('btn-tax').disabled=true; let w=0; let int=setInterval(()=>{if(!isPaused){w+=5; document.getElementById('tax-cd').style.width=w/20+"%"; if(w>=2000){clearInterval(int);taxReady=true;document.getElementById('btn-tax').disabled=false;}}},10); updateUI(); }
    function setTactic(t) { currentTactic=t; document.querySelectorAll('.tactic-card').forEach(e=>e.classList.remove('active')); document.getElementById('tac-'+t).classList.add('active'); const b=document.getElementById('ui-tactic-badge'); b.innerText=t.toUpperCase(); document.getElementById('ui-recruit-cost').innerText=t==='speed'?4:5; updateUI(); }
    
    function attemptMove(from, to) { if(isPaused) return; const r1=Math.floor(from/GRID_W),c1=from%GRID_W,r2=Math.floor(to/GRID_W),c2=to%GRID_W; if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return; const s=tiles[from],d=tiles[to]; if(s.army<=1)return; let f=Math.floor(s.army/2); s.army-=f; let atk=f; if(currentTactic==='attack') atk=Math.floor(f*1.5); if(currentTactic==='defense') atk=Math.floor(f*0.7); if(currentTactic==='speed') atk=Math.floor(f*0.8); if(d.owner===1){d.army+=f;} else { if(d.owner===0 && d.hiddenBarb>0){ playSound('ambush'); d.army+=d.hiddenBarb; d.hiddenBarb=0; d.owner=3; d.el.classList.add('barbarian'); showFloatText("PUSU!",d.el,'bad'); if(atk>d.army){d.army=atk-d.army; d.owner=1; d.el.classList.remove('barbarian'); missionUpdate('kill',5); missionUpdate('conquer',1); taxEfficiency=Math.min(100, taxEfficiency+10);} else {d.army-=atk;} } else { if(atk>d.army){ missionUpdate('kill',d.army); d.army=atk-d.army; d.owner=1; d.trap=0; d.hiddenBarb=0; playSound('fight'); missionUpdate('conquer',1); taxEfficiency=Math.min(100, taxEfficiency+10); if(tiles.filter(t=>t.owner===2).length===0){ checkAchievement('first_win'); if(level>=5) checkAchievement('survivor'); alert("ZAFER!"); level++; init(true); } } else { missionUpdate('kill',atk); d.army-=atk; playSound('fight'); taxEfficiency=Math.max(10, taxEfficiency-10); } } } updateUI(); }

    function updateUI() { document.getElementById('ui-gold').innerText=gold; const pTiles=tiles.filter(t=>t.owner===1); let baseInc=pTiles.reduce((s,t)=>s+t.economy,0)+incomeBonus+5; document.getElementById('ui-income').innerText=Math.floor(baseInc*(taxEfficiency/100)); document.getElementById('ui-efficiency').innerText=taxEfficiency; tiles.forEach(t=>{const el=t.el; el.className='tile'; if(t.owner===1) el.classList.add('player'); else if(t.owner===2) el.classList.add('enemy'); else if(t.owner===3) el.classList.add('barbarian'); else el.classList.add('neutral'); el.querySelector('.trap-indicator').style.display=(t.trap>0&&t.owner===0)?'block':'none'; el.querySelector('.base-indicator').style.display=(t.id===baseIdx&&t.owner===1)?'block':'none'; if(selectedIdx===t.id) el.style.border="2px solid white"; else el.style.border=""; el.querySelector('span').innerText=t.army;}); saveGame(); }
    
    // UI Helpers
    function togglePause(){ isPaused=!isPaused; document.getElementById('pause-overlay').style.display=isPaused?'flex':'none'; }
    function openModal(id){ document.getElementById(id).style.display='flex'; isPaused=true; }
    function closeModal(id){ document.getElementById(id).style.display='none'; isPaused=false; }
    function openSettings(){ openModal('settings-modal'); }
    function fullReset(){ localStorage.clear(); location.reload(); }
    function submitCode(){ const v=document.getElementById('cheat-code').value.toUpperCase(); if(v==='PARA'){gold+=500;updateUI();closeModal('settings-modal');} else if(v==='LEVEL'){level++;init(true);closeModal('settings-modal');} }
    function buyItem(t){ if(t==='income'&&gold>=50){gold-=50;incomeBonus+=3;} else if(t==='merc'&&gold>=40){if(selectedIdx!==null&&tiles[selectedIdx].owner===1){gold-=40;tiles[selectedIdx].army+=15;}} else if(t==='nuke'&&gold>=120){gold-=120;tiles.forEach(x=>{if(x.owner===2)x.army=1});} else if(t==='fort'&&gold>=60){if(tiles[baseIdx].owner===1){gold-=60;tiles[baseIdx].army+=25;}} else if(t==='spy'&&gold>=75){gold-=75;tiles.forEach(x=>{if(x.hiddenBarb>0)x.el.classList.add('revealed')});} missionUpdate('spend',50); closeModal('shop-modal'); updateUI(); }
    function setSkin(w,c){document.documentElement.style.setProperty('--'+w,c);saveGame();}
    function openMissions() { document.getElementById('quest-alert').style.display='none'; let h=''; dailyMissions.forEach(m=>{h+=`<div class="list-item"><div>${m.desc}<br><small>${m.current}/${m.target}</small></div><div style="color:${m.done?'#2ecc71':'var(--gold)'}">${m.done?'OK':'+'+m.reward}</div></div>`;}); document.getElementById('mission-list').innerHTML=h; openModal('missions-modal'); }
    function showFloatText(t,e,c){const r=e.getBoundingClientRect();const d=document.createElement('div');d.className='float-text '+(c||'');d.innerText=t;d.style.left=r.left+'px';d.style.top=r.top+'px';document.body.appendChild(d);setTimeout(()=>d.remove(),1000);}
    function animPop(i){tiles[i].el.classList.remove('anim-pop');void tiles[i].el.offsetWidth;tiles[i].el.classList.add('anim-pop');}
    
    // Drag
    function startDrag(e){if(isPaused)return;if(e.target.closest('.tile')){e.preventDefault();const i=parseInt(e.target.closest('.tile').dataset.idx);if(tiles[i].owner===1){baseIdx=i;playSound('coin');}if(tiles[i].owner===1||tiles[i].owner===0){selectedIdx=i;updateUI();}if(tiles[i].owner===1){isDragging=true;dragStartIdx=i;}}}
    function doDrag(e){if(!isDragging||isPaused)return;e.preventDefault();const t=e.touches?e.touches[0]:e;const b=tiles[dragStartIdx].el.getBoundingClientRect();drawArrow(b.left+b.width/2,b.top+b.height/2,t.clientX,t.clientY);}
    function endDrag(e){if(!isDragging)return;isDragging=false;document.getElementById('drag-line').style.display='none';document.getElementById('drag-head').style.display='none';const t=e.changedTouches?e.changedTouches[0]:e;const el=document.elementFromPoint(t.clientX,t.clientY);if(el&&el.closest('.tile')){const i=parseInt(el.closest('.tile').dataset.idx);if(i!==dragStartIdx)attemptMove(dragStartIdx,i);}}
    function drawArrow(x1,y1,x2,y2){const l=document.getElementById('drag-line'),h=document.getElementById('drag-head');l.style.display='block';l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);const a=Math.atan2(y2-y1,x2-x1);h.style.display='block';h.setAttribute('points',`${x2},${y2} ${x2-20*Math.cos(a-0.5)},${y2-20*Math.sin(a-0.5)} ${x2-20*Math.cos(a+0.5)},${y2-20*Math.sin(a+0.5)}`);}

    init();
</script>
</body>
</html>
